'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = createCachingHashbelt;
class BasicHashbeltMap {
  // BasicHashbeltMap
  //   options: @{}
  //     create  --  function that returns a Map-compatible object,
  //                 implementing has(), get(), set(), delete(), entries(), and clear()
  //     tip     --  initial Map-compatible object to use as the tip

  constructor(opts) {
    if (null == opts) {
      opts = {};
    } else if ('function' === typeof opts) {
      opts = { create: opts };
    }

    const createTip = 'function' === typeof opts.create ? opts.create.bind(opts) : () => new Map();

    const tip = null != opts.tip ? opts.tip : createTip();

    Object.defineProperties(this, {
      _createTip: { value: createTip },
      _belt: { writable: true, value: [tip] },
      _tid: { writable: true, value: null } });
  }

  setAutoRotateInterval(ms_delay) {
    if (this._tid) {
      clearInterval(this._tid);
    }
    if (null != ms_delay) {
      const tid = setInterval(() => this.rotate(), ms_delay);
      if ('function' === typeof tid.unref) {
        tid.unref();
      }
      this._tid = tid;
    }
    return this;
  }

  rotate() {
    this._belt = this._cull_hashbelt([this._createTip()].concat(this._belt));
    return this;
  }

  _cull_hashbelt(belt) {
    return belt;
  }

  has(key) {
    for (const each of this._belt) {
      if (each.has(key)) {
        this._hit_has(key, each);
        return true;
      }
    }

    return !!this._miss_has(key);
  }

  _hit_has(key, coll) {}
  _miss_has(key) {}

  get(key) {
    for (const each of this._belt) {
      if (each.has(key)) {
        const value = each.get(key);
        this._hit_get(key, value, each);
        return value;
      }
    }
    return this._miss_get(key);
  }

  _hit_get(key, value, coll) {}
  _miss_get(key) {}

  set(key, value) {
    const tip = this._belt[0];
    this._hit_set(key, value, tip);
    tip.set(key, value);
    return this;
  }

  _hit_set(key, value, coll) {}

  delete(key) {
    for (const each of this._belt) {
      if (each.has(key)) {
        this._hit_delete(key, each);
        return each.delete(key);
      }
    }

    return !!this._miss_delete(key);
  }

  _hit_delete(key, coll) {}
  _miss_delete(key) {}

  clear() {
    const previous = this._belt;
    this._belt = [new this._createTip()];

    if (previous) {
      for (const each of previous) {
        each.clear();
      }
    }
  }

  *entries() {
    const seen = new Set();
    let sz = seen.size;

    for (const each of this._belt) {
      for (const entry of each.entries()) {
        seen.add(entry[0]);
        if (sz !== seen.size) {
          sz = seen.size;
          yield entry;
        }
      }
    }
  }

  [Symbol.iterator]() {
    return this.entries();
  }
  *keys() {
    for (const entry of this.entries()) {
      yield entry[0];
    }
  }
  *values() {
    for (const entry of this.entries()) {
      yield entry[1];
    }
  }
  forEach(callback, thisArg) {
    return new Map(this.entries()).forEach(callback, thisArg);
  }
}exports.BasicHashbeltMap = BasicHashbeltMap;
class HashbeltMap extends BasicHashbeltMap {
  constructor(opts) {
    if (null == opts) {
      opts = {};
    }
    super(opts);
    Object.defineProperties(this, {
      capacity: { value: opts.capacity || 5 } });
  }

  _cull_hashbelt(belt) {
    const capacity = this.capacity;
    if (null != capacity) {
      belt = belt.slice(0, this.capacity);
    }
    return belt;
  }

  autoRotate(ms_delay = 60000) {
    return this.setAutoRotateInterval(ms_delay);
  }
}exports.HashbeltMap = HashbeltMap;
const Hashbelt = exports.Hashbelt = HashbeltMap;

class ReadCachingHashbeltMap extends HashbeltMap {
  _hit_get(key, value, coll) {
    // copy the hit to the front of the cache
    const tip = this._belt[0];
    tip.set(key, value);
  }
}exports.ReadCachingHashbeltMap = ReadCachingHashbeltMap;
const CachingHashbeltMap = exports.CachingHashbeltMap = ReadCachingHashbeltMap;
const CachingHashbelt = exports.CachingHashbelt = ReadCachingHashbeltMap;

function createCachingHashbelt(opts) {
  return new ReadCachingHashbeltMap(opts);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2NvZGUvaW5kZXguanN5Il0sIm5hbWVzIjpbImNyZWF0ZUNhY2hpbmdIYXNoYmVsdCIsIkJhc2ljSGFzaGJlbHRNYXAiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJjcmVhdGUiLCJjcmVhdGVUaXAiLCJiaW5kIiwiTWFwIiwidGlwIiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydGllcyIsIl9jcmVhdGVUaXAiLCJ2YWx1ZSIsIl9iZWx0Iiwid3JpdGFibGUiLCJfdGlkIiwic2V0QXV0b1JvdGF0ZUludGVydmFsIiwibXNfZGVsYXkiLCJjbGVhckludGVydmFsIiwidGlkIiwic2V0SW50ZXJ2YWwiLCJyb3RhdGUiLCJ1bnJlZiIsIl9jdWxsX2hhc2hiZWx0IiwiY29uY2F0IiwiYmVsdCIsImhhcyIsImtleSIsImVhY2giLCJfaGl0X2hhcyIsIl9taXNzX2hhcyIsImNvbGwiLCJnZXQiLCJfaGl0X2dldCIsIl9taXNzX2dldCIsInNldCIsIl9oaXRfc2V0IiwiZGVsZXRlIiwiX2hpdF9kZWxldGUiLCJfbWlzc19kZWxldGUiLCJjbGVhciIsInByZXZpb3VzIiwiZW50cmllcyIsInNlZW4iLCJTZXQiLCJzeiIsInNpemUiLCJlbnRyeSIsImFkZCIsIlN5bWJvbCIsIml0ZXJhdG9yIiwia2V5cyIsInZhbHVlcyIsImZvckVhY2giLCJjYWxsYmFjayIsInRoaXNBcmciLCJIYXNoYmVsdE1hcCIsImNhcGFjaXR5Iiwic2xpY2UiLCJhdXRvUm90YXRlIiwiSGFzaGJlbHQiLCJSZWFkQ2FjaGluZ0hhc2hiZWx0TWFwIiwiQ2FjaGluZ0hhc2hiZWx0TWFwIiwiQ2FjaGluZ0hhc2hiZWx0Il0sIm1hcHBpbmdzIjoiOzs7OztrQkF5SndCQSxxQjtBQXhKakIsTUFBTUMsZ0JBQU4sQ0FBdUI7QUFDNUI7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQUMsY0FBWUMsSUFBWixFQUFrQjtBQUNoQixRQUFHLFFBQVFBLElBQVgsRUFBa0I7QUFBQ0EsYUFBTyxFQUFQO0FBQVMsS0FB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QUEyQztBQWRHLEMsUUFBckN1QyxXLEdBQUFBLFc7QUFnQk4sTUFBTUksOEJBQVdKLFdBQWpCOztBQUlBLE1BQU1LLHNCQUFOLFNBQXFDTCxXQUFyQyxDQUFpRDtBQUN0RHZCLFdBQVNOLEdBQVQsRUFBY2YsS0FBZCxFQUFxQm1CLElBQXJCLEVBQTJCO0FBQ3pCO0FBQ0EsVUFBTXZCLE1BQU0sS0FBS0ssS0FBTCxDQUFXLENBQVgsQ0FBWjtBQUNBTCxRQUFJMkIsR0FBSixDQUFRUixHQUFSLEVBQWFmLEtBQWI7QUFBbUI7QUFKaUMsQyxRQUEzQ2lELHNCLEdBQUFBLHNCO0FBTU4sTUFBTUMsa0RBQXFCRCxzQkFBM0I7QUFDQSxNQUFNRSw0Q0FBa0JGLHNCQUF4Qjs7QUFFUSxTQUFTN0QscUJBQVQsQ0FBK0JHLElBQS9CLEVBQXFDO0FBQ2xELFNBQU8sSUFBSTBELHNCQUFKLENBQTZCMUQsSUFBN0IsQ0FBUDtBQUF3QyIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxuZXhwb3J0IGNsYXNzIEJhc2ljSGFzaGJlbHRNYXAgOjpcbiAgLy8gQmFzaWNIYXNoYmVsdE1hcFxuICAvLyAgIG9wdGlvbnM6IEB7fVxuICAvLyAgICAgY3JlYXRlICAtLSAgZnVuY3Rpb24gdGhhdCByZXR1cm5zIGEgTWFwLWNvbXBhdGlibGUgb2JqZWN0LFxuICAvLyAgICAgICAgICAgICAgICAgaW1wbGVtZW50aW5nIGhhcygpLCBnZXQoKSwgc2V0KCksIGRlbGV0ZSgpLCBlbnRyaWVzKCksIGFuZCBjbGVhcigpXG4gIC8vICAgICB0aXAgICAgIC0tICBpbml0aWFsIE1hcC1jb21wYXRpYmxlIG9iamVjdCB0byB1c2UgYXMgdGhlIHRpcFxuXG4gIGNvbnN0cnVjdG9yKG9wdHMpIDo6XG4gICAgaWYgbnVsbCA9PSBvcHRzIDo6IG9wdHMgPSB7fVxuICAgIGVsc2UgaWYgJ2Z1bmN0aW9uJyA9PT0gdHlwZW9mIG9wdHMgOjpcbiAgICAgIG9wdHMgPSBAOiBjcmVhdGU6IG9wdHNcblxuICAgIGNvbnN0IGNyZWF0ZVRpcCA9ICdmdW5jdGlvbicgPT09IHR5cGVvZiBvcHRzLmNyZWF0ZVxuICAgICAgPyBvcHRzLmNyZWF0ZS5iaW5kKG9wdHMpXG4gICAgICA6ICgpID0+IG5ldyBNYXAoKVxuXG4gICAgY29uc3QgdGlwID0gbnVsbCAhPSBvcHRzLnRpcFxuICAgICAgPyBvcHRzLnRpcCA6IGNyZWF0ZVRpcCgpXG5cbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyBAIHRoaXMsIEA6XG4gICAgICBfY3JlYXRlVGlwOiBAOiB2YWx1ZTogY3JlYXRlVGlwXG4gICAgICBfYmVsdDogQDogd3JpdGFibGU6IHRydWUsIHZhbHVlOiBbdGlwXVxuICAgICAgX3RpZDogQDogd3JpdGFibGU6IHRydWUsIHZhbHVlOiBudWxsXG5cblxuICBzZXRBdXRvUm90YXRlSW50ZXJ2YWwobXNfZGVsYXkpIDo6XG4gICAgaWYgdGhpcy5fdGlkIDo6IGNsZWFySW50ZXJ2YWwodGhpcy5fdGlkKVxuICAgIGlmIG51bGwgIT0gbXNfZGVsYXkgOjpcbiAgICAgIGNvbnN0IHRpZCA9IHNldEludGVydmFsIEAgKCkgPT4gdGhpcy5yb3RhdGUoKSwgbXNfZGVsYXlcbiAgICAgIGlmICdmdW5jdGlvbicgPT09IHR5cGVvZiB0aWQudW5yZWYgOjpcbiAgICAgICAgdGlkLnVucmVmKClcbiAgICAgIHRoaXMuX3RpZCA9IHRpZFxuICAgIHJldHVybiB0aGlzXG5cbiAgcm90YXRlKCkgOjpcbiAgICB0aGlzLl9iZWx0ID0gdGhpcy5fY3VsbF9oYXNoYmVsdCBAXG4gICAgICBbdGhpcy5fY3JlYXRlVGlwKCldXG4gICAgICAgIC5jb25jYXQgQCB0aGlzLl9iZWx0XG4gICAgcmV0dXJuIHRoaXNcblxuICBfY3VsbF9oYXNoYmVsdChiZWx0KSA6OiByZXR1cm4gYmVsdFxuXG5cblxuICBoYXMoa2V5KSA6OlxuICAgIGZvciBjb25zdCBlYWNoIG9mIHRoaXMuX2JlbHQgOjpcbiAgICAgIGlmIGVhY2guaGFzKGtleSkgOjpcbiAgICAgICAgdGhpcy5faGl0X2hhcyhrZXksIGVhY2gpXG4gICAgICAgIHJldHVybiB0cnVlXG5cbiAgICByZXR1cm4gISEgdGhpcy5fbWlzc19oYXMoa2V5KVxuXG4gIF9oaXRfaGFzKGtleSwgY29sbCkgOjpcbiAgX21pc3NfaGFzKGtleSkgOjpcblxuXG4gIGdldChrZXkpIDo6XG4gICAgZm9yIGNvbnN0IGVhY2ggb2YgdGhpcy5fYmVsdCA6OlxuICAgICAgaWYgZWFjaC5oYXMoa2V5KSA6OlxuICAgICAgICBjb25zdCB2YWx1ZSA9IGVhY2guZ2V0KGtleSlcbiAgICAgICAgdGhpcy5faGl0X2dldChrZXksIHZhbHVlLCBlYWNoKVxuICAgICAgICByZXR1cm4gdmFsdWVcbiAgICByZXR1cm4gdGhpcy5fbWlzc19nZXQoa2V5KVxuXG4gIF9oaXRfZ2V0KGtleSwgdmFsdWUsIGNvbGwpIDo6XG4gIF9taXNzX2dldChrZXkpIDo6XG5cblxuICBzZXQoa2V5LCB2YWx1ZSkgOjpcbiAgICBjb25zdCB0aXAgPSB0aGlzLl9iZWx0WzBdXG4gICAgdGhpcy5faGl0X3NldChrZXksIHZhbHVlLCB0aXApXG4gICAgdGlwLnNldChrZXksIHZhbHVlKVxuICAgIHJldHVybiB0aGlzXG5cbiAgX2hpdF9zZXQoa2V5LCB2YWx1ZSwgY29sbCkgOjpcblxuXG4gIGRlbGV0ZShrZXkpIDo6XG4gICAgZm9yIGNvbnN0IGVhY2ggb2YgdGhpcy5fYmVsdCA6OlxuICAgICAgaWYgZWFjaC5oYXMoa2V5KSA6OlxuICAgICAgICB0aGlzLl9oaXRfZGVsZXRlKGtleSwgZWFjaClcbiAgICAgICAgcmV0dXJuIGVhY2guZGVsZXRlKGtleSlcblxuICAgIHJldHVybiAhISB0aGlzLl9taXNzX2RlbGV0ZShrZXkpXG5cbiAgX2hpdF9kZWxldGUoa2V5LCBjb2xsKSA6OlxuICBfbWlzc19kZWxldGUoa2V5KSA6OlxuXG5cblxuICBjbGVhcigpIDo6XG4gICAgY29uc3QgcHJldmlvdXMgPSB0aGlzLl9iZWx0XG4gICAgdGhpcy5fYmVsdCA9IFtuZXcgdGhpcy5fY3JlYXRlVGlwKCldXG5cbiAgICBpZiBwcmV2aW91cyA6OlxuICAgICAgZm9yIGNvbnN0IGVhY2ggb2YgcHJldmlvdXMgOjpcbiAgICAgICAgZWFjaC5jbGVhcigpXG5cblxuICAqZW50cmllcygpIDo6XG4gICAgY29uc3Qgc2VlbiA9IG5ldyBTZXQoKVxuICAgIGxldCBzeiA9IHNlZW4uc2l6ZVxuXG4gICAgZm9yIGNvbnN0IGVhY2ggb2YgdGhpcy5fYmVsdCA6OlxuICAgICAgZm9yIGNvbnN0IGVudHJ5IG9mIGVhY2guZW50cmllcygpIDo6XG4gICAgICAgIHNlZW4uYWRkKGVudHJ5WzBdKVxuICAgICAgICBpZiBzeiAhPT0gc2Vlbi5zaXplIDo6XG4gICAgICAgICAgc3ogPSBzZWVuLnNpemVcbiAgICAgICAgICB5aWVsZCBlbnRyeVxuXG4gIFtTeW1ib2wuaXRlcmF0b3JdKCkgOjpcbiAgICByZXR1cm4gdGhpcy5lbnRyaWVzKClcbiAgKmtleXMoKSA6OlxuICAgIGZvciBjb25zdCBlbnRyeSBvZiB0aGlzLmVudHJpZXMoKSA6OlxuICAgICAgeWllbGQgZW50cnlbMF1cbiAgKnZhbHVlcygpIDo6XG4gICAgZm9yIGNvbnN0IGVudHJ5IG9mIHRoaXMuZW50cmllcygpIDo6XG4gICAgICB5aWVsZCBlbnRyeVsxXVxuICBmb3JFYWNoKGNhbGxiYWNrLCB0aGlzQXJnKSA6OlxuICAgIHJldHVybiBuZXcgTWFwKHRoaXMuZW50cmllcygpKS5mb3JFYWNoKGNhbGxiYWNrLCB0aGlzQXJnKVxuXG5cblxuZXhwb3J0IGNsYXNzIEhhc2hiZWx0TWFwIGV4dGVuZHMgQmFzaWNIYXNoYmVsdE1hcCA6OlxuICBjb25zdHJ1Y3RvcihvcHRzKSA6OlxuICAgIGlmIG51bGwgPT0gb3B0cyA6OiBvcHRzID0ge31cbiAgICBzdXBlcihvcHRzKVxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzIEAgdGhpcywgQDpcbiAgICAgICAgY2FwYWNpdHk6IEA6IHZhbHVlOiBvcHRzLmNhcGFjaXR5IHx8IDVcblxuICBfY3VsbF9oYXNoYmVsdChiZWx0KSA6OlxuICAgIGNvbnN0IGNhcGFjaXR5ID0gdGhpcy5jYXBhY2l0eVxuICAgIGlmIG51bGwgIT0gY2FwYWNpdHkgOjpcbiAgICAgIGJlbHQgPSBiZWx0LnNsaWNlIEAgMCwgdGhpcy5jYXBhY2l0eVxuICAgIHJldHVybiBiZWx0XG5cbiAgYXV0b1JvdGF0ZShtc19kZWxheT02MDAwMCkgOjpcbiAgICByZXR1cm4gdGhpcy5zZXRBdXRvUm90YXRlSW50ZXJ2YWwobXNfZGVsYXkpXG5cbmV4cG9ydCBjb25zdCBIYXNoYmVsdCA9IEhhc2hiZWx0TWFwXG5cblxuXG5leHBvcnQgY2xhc3MgUmVhZENhY2hpbmdIYXNoYmVsdE1hcCBleHRlbmRzIEhhc2hiZWx0TWFwIDo6XG4gIF9oaXRfZ2V0KGtleSwgdmFsdWUsIGNvbGwpIDo6XG4gICAgLy8gY29weSB0aGUgaGl0IHRvIHRoZSBmcm9udCBvZiB0aGUgY2FjaGVcbiAgICBjb25zdCB0aXAgPSB0aGlzLl9iZWx0WzBdXG4gICAgdGlwLnNldChrZXksIHZhbHVlKVxuXG5leHBvcnQgY29uc3QgQ2FjaGluZ0hhc2hiZWx0TWFwID0gUmVhZENhY2hpbmdIYXNoYmVsdE1hcFxuZXhwb3J0IGNvbnN0IENhY2hpbmdIYXNoYmVsdCA9IFJlYWRDYWNoaW5nSGFzaGJlbHRNYXBcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gY3JlYXRlQ2FjaGluZ0hhc2hiZWx0KG9wdHMpIDo6XG4gIHJldHVybiBuZXcgUmVhZENhY2hpbmdIYXNoYmVsdE1hcCBAIG9wdHNcblxuIl19